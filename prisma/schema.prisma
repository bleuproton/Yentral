generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  ACCOUNTANT_ADMIN
  ACCOUNTANT_READONLY
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum OrderStatus {
  PENDING
  PAID
  FULFILLED
  CANCELLED
  REFUNDED
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum JournalStatus {
  DRAFT
  POSTED
  VOID
}

enum JournalSource {
  INVOICE
  PAYMENT
  SHIPMENT
  RETURN
  MANUAL
  ADJUSTMENT
}

enum ConnectorType {
  CHANNEL
  WMS
  PAYMENTS
  OTHER
}

enum StockLedgerKind {
  RECEIPT
  RESERVE
  RELEASE
  SHIP
  RETURN
  ADJUST
}

enum ReservationStatus {
  ACTIVE
  RELEASED
  CONSUMED
}

enum ShipmentStatus {
  CREATED
  LABEL_PURCHASED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum ReturnStatus {
  REQUESTED
  APPROVED
  RECEIVED
  REFUNDED
  REJECTED
}

enum MailboxProvider {
  GENERIC_WEBHOOK
  SMTP_IMAP
}

enum EmailDirection {
  INBOUND
  OUTBOUND
}

enum EmailThreadStatus {
  OPEN
  CLOSED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  VOID
}

model Tenant {
  id                     String                  @id @default(cuid())
  slug                   String                  @unique
  name                   String
  stripeCustomerId       String?
  stripeSubscriptionId   String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  memberships            Membership[]
  products               Product[]
  inventoryItems         InventoryItem[]
  orders                 Order[]
  orderLines             OrderLine[]
  pluginInstallations    PluginInstallation[]
  jobs                   Job[]
  tickets                Ticket[]
  jobRuns                JobRun[]
  organizations          Organization[]
  legalEntities          LegalEntity[]
  taxProfiles            TaxProfile[]
  warehouses             Warehouse[]
  auditEvents            AuditEvent[]
  integrationConnections IntegrationConnection[]
  productVariants        ProductVariant[]
  stockLedgers           StockLedger[]
  stockSnapshots         StockSnapshot[]
  stockReservations      StockReservation[]
  warehouseMappings      WarehouseMapping[]
  channelProducts        ChannelProduct[]
  channelVariants        ChannelVariant[]
  channelOrders          ChannelOrder[]
  quotes                 Quote[]
  quoteLines             QuoteLine[]
  documentTemplates      DocumentTemplate[]
  documentRenders        DocumentRender[]
  gLAccounts             GLAccount[]
  journalEntries         JournalEntry[]
  journalLines           JournalLine[]
  vatRegistrations       VatRegistration[]
  vatTransactions        VatTransaction[]
  reportExports          ReportExport[]
  shipments              Shipment[]              @relation("TenantShipments")
  returns                Return[]                @relation("TenantReturns")
  shipmentLines          ShipmentLine[]          @relation("TenantShipmentLines")
  returnLines            ReturnLine[]            @relation("TenantReturnLines")
  customers              Customer[]
  invoices               Invoice[]
  invoiceLines           InvoiceLine[]
  mailboxes              Mailbox[]
  emailThreads           EmailThread[]
  emailMessages          EmailMessage[]
  mediaAssets            MediaAsset[]
  productMedia           ProductMedia[]
  variantMedia           VariantMedia[]
  flows                  Flow[]
  flowVersions           FlowVersion[]
  flowTemplates          FlowTemplate[]
  flowRuns               FlowRun[]
  flowRunLogs            FlowRunLog[]
  webhookEndpoints       WebhookEndpoint[]
  secrets                Secret[]
  credentials            Credential[]
  accountingPeriods      AccountingPeriod[]
  postingLocks           PostingLock[]
  accountantAccesses     AccountantAccess[]
  flowRunSteps           FlowRunStep[]
}

model User {
  id              String       @id @default(cuid())
  email           String       @unique
  name            String?
  image           String?
  password        String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  accounts        Account[]
  sessions        Session[]
  memberships     Membership[]
  orders          Order[]      @relation("UserOrders")
  tickets         Ticket[]     @relation("TicketAuthor")
  assignedTickets Ticket[]     @relation("TicketAssignee")
  auditEvents     AuditEvent[]
  accountantAccesses AccountantAccess[]
}

model Membership {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String
  role      Role     @default(MEMBER)
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

model Product {
  id              String           @id @default(cuid())
  tenantId        String
  sku             String
  name            String
  description     String?
  priceCents      Int
  currency        String           @default("USD")
  status          ProductStatus    @default(DRAFT)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  inventory       InventoryItem[]
  orderLines      OrderLine[]
  variants        ProductVariant[]
  channelProducts ChannelProduct[]
  productMedia    ProductMedia[]
  quoteLines      QuoteLine[]

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, sku])
  @@unique([tenantId, id])
}

model ProductVariant {
  id         String   @id @default(cuid())
  tenantId   String
  productId  String
  sku        String
  ean        String?
  attributes Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product           Product            @relation(fields: [tenantId, productId], references: [tenantId, id], onDelete: Cascade)
  orderLines        OrderLine[]
  stockLedgers      StockLedger[]
  stockSnapshots    StockSnapshot[]
  stockReservations StockReservation[]
  channelVariants   ChannelVariant[]
  shipmentLines     ShipmentLine[]
  returnLines       ReturnLine[]
  InvoiceLine       InvoiceLine[]
  variantMedia      VariantMedia[]

  @@unique([tenantId, sku])
  @@unique([tenantId, id])
  @@index([tenantId, productId])
}

model MediaAsset {
  id        String   @id @default(cuid())
  tenantId  String
  url       String
  provider  String
  mimeType  String?
  sizeBytes Int?
  width     Int?
  height    Int?
  checksum  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  productMedia ProductMedia[]
  variantMedia VariantMedia[]

  @@index([tenantId, checksum])
  @@unique([tenantId, id])
}

model ProductMedia {
  id        String   @id @default(cuid())
  tenantId  String
  productId String
  assetId   String
  sortOrder Int      @default(0)
  altText   String?
  createdAt DateTime @default(now())

  tenant  Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product  @relation(fields: [tenantId, productId], references: [tenantId, id], onDelete: Cascade)
  asset   MediaAsset @relation(fields: [tenantId, assetId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, productId, assetId])
  @@unique([tenantId, id])
}

model VariantMedia {
  id        String   @id @default(cuid())
  tenantId  String
  variantId String
  assetId   String
  sortOrder Int      @default(0)
  altText   String?
  createdAt DateTime @default(now())

  tenant  Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [tenantId, variantId], references: [tenantId, id], onDelete: Cascade)
  asset   MediaAsset     @relation(fields: [tenantId, assetId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, variantId, assetId])
  @@unique([tenantId, id])
}

enum FlowRunStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  INVOICED
}

enum DocumentType {
  QUOTE
  INVOICE
  REPORT
}

enum DocumentRenderStatus {
  PENDING
  COMPLETED
  FAILED
}

enum AccountingPeriodStatus {
  OPEN
  CLOSED
}

enum ReportExportType {
  OSS_VAT
  LOCAL_VAT
  EPR
  GL_EXPORT
  VAT_OSS
  GL_JOURNAL
  INVOICE_LIST
}

model Flow {
  id          String       @id @default(cuid())
  tenantId    String
  name        String
  slug        String?
  description String?
  status      FlowStatus   @default(DRAFT)
  definition  Json?
  publishedAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  versions    FlowVersion[]
  runs        FlowRun[]
  webhooks    WebhookEndpoint[]

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@unique([tenantId, slug])
}

enum FlowStatus {
  DRAFT
  PUBLISHED
}

model FlowVersion {
  id        String   @id @default(cuid())
  tenantId  String
  flowId    String
  version   Int
  definition Json
  published Boolean  @default(false)
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  flow   Flow   @relation(fields: [tenantId, flowId], references: [tenantId, id], onDelete: Cascade)
  runs   FlowRun[]

  @@unique([tenantId, id])
  @@unique([tenantId, flowId, version])
  @@index([tenantId, flowId])
}

model FlowTemplate {
  id         String   @id @default(cuid())
  tenantId   String
  name       String
  definition Json
  createdAt  DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@unique([tenantId, name])
}

model FlowRun {
  id             String        @id @default(cuid())
  tenantId       String
  flowId         String
  flowVersionId  String
  status         FlowRunStatus @default(PENDING)
  startedAt      DateTime?     @default(now())
  finishedAt     DateTime?
  input          Json?
  output         Json?
  error          String?
  triggerType    String?
  triggerPayload Json?
  createdAt      DateTime      @default(now())

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  flow        Flow        @relation(fields: [tenantId, flowId], references: [tenantId, id], onDelete: Cascade)
  flowVersion FlowVersion @relation(fields: [tenantId, flowVersionId], references: [tenantId, id], onDelete: Cascade)
  logs        FlowRunLog[]
  steps       FlowRunStep[]

  @@unique([tenantId, id])
  @@index([tenantId, status])
  @@index([tenantId, flowId])
}

model FlowRunLog {
  id        String   @id @default(cuid())
  tenantId  String
  runId     String
  level     String
  message   String
  data      Json?
  createdAt DateTime @default(now())

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  run    FlowRun @relation(fields: [tenantId, runId], references: [tenantId, id], onDelete: Cascade)

  @@index([tenantId, runId])
  @@unique([tenantId, id])
}

model FlowRunStep {
  id         String   @id @default(cuid())
  tenantId   String
  flowRunId  String
  nodeId     String
  status     String
  startedAt  DateTime? @default(now())
  finishedAt DateTime?
  input      Json?
  output     Json?
  error      String?

  tenant Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  run    FlowRun @relation(fields: [tenantId, flowRunId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId, flowRunId])
}

model WebhookEndpoint {
  id        String   @id @default(cuid())
  tenantId  String
  flowId    String
  token     String
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  flow   Flow   @relation(fields: [tenantId, flowId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@unique([tenantId, token])
}

model Secret {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  credentials Credential[]

  @@unique([tenantId, id])
  @@unique([tenantId, name])
}

model Credential {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  type      String
  provider  String?
  config    Json?
  secretId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  secret Secret? @relation(fields: [tenantId, secretId], references: [tenantId, id], onDelete: SetNull)

  @@unique([tenantId, id])
  @@unique([tenantId, name])
}

model Quote {
  id            String       @id @default(cuid())
  tenantId      String
  customerId    String?
  status        QuoteStatus  @default(DRAFT)
  currency      String       @default("EUR")
  subtotalCents Int
  taxCents      Int
  totalCents    Int
  expiresAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  lines         QuoteLine[]

  tenant   Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [tenantId, customerId], references: [tenantId, id], onDelete: SetNull)

  @@unique([tenantId, id])
}

model QuoteLine {
  id          String   @id @default(cuid())
  tenantId    String
  quoteId     String
  productId   String?
  description String?
  quantity    Int
  unitCents   Int
  totalCents  Int

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  quote   Quote   @relation(fields: [tenantId, quoteId], references: [tenantId, id], onDelete: Cascade)
  product Product? @relation(fields: [tenantId, productId], references: [tenantId, id], onDelete: SetNull)

  @@unique([tenantId, id])
  @@index([tenantId, quoteId])
}

model DocumentTemplate {
  id           String        @id @default(cuid())
  tenantId     String
  key          String
  name         String
  type         DocumentType
  templateHtml String
  engine       String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  renders      DocumentRender[]

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@unique([tenantId, key])
}

model DocumentRender {
  id         String                @id @default(cuid())
  tenantId   String
  templateId String
  refType    String
  refId      String
  status     DocumentRenderStatus  @default(PENDING)
  outputUrl  String?
  payloadJson Json?
  createdAt  DateTime              @default(now())
  finishedAt DateTime?

  tenant   Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  template DocumentTemplate @relation(fields: [tenantId, templateId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId, refType, refId])
}

model GLAccount {
  id       String @id @default(cuid())
  tenantId String
  code     String
  name     String
  type     String
  lines    JournalLine[]

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@unique([tenantId, code])
}

model JournalEntry {
  id             String   @id @default(cuid())
  tenantId       String
  legalEntityId  String
  refType        String?
  refId          String?
  postedAt       DateTime @default(now())
  createdAt      DateTime @default(now())
  lines          JournalLine[]

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legalEntity LegalEntity @relation(fields: [tenantId, legalEntityId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId, postedAt])
}

model JournalLine {
  id         String   @id @default(cuid())
  tenantId   String
  entryId    String
  accountId  String
  debitCents Int      @default(0)
  creditCents Int     @default(0)
  currency   String   @default("EUR")

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entry   JournalEntry @relation(fields: [tenantId, entryId], references: [tenantId, id], onDelete: Cascade)
  account GLAccount    @relation(fields: [tenantId, accountId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId, entryId])
}

model VatRegistration {
  id             String   @id @default(cuid())
  tenantId       String
  jurisdictionId String
  vatNumber      String
  ossEnabled     Boolean  @default(false)
  createdAt      DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@unique([tenantId, vatNumber])
}

model VatTransaction {
  id             String   @id @default(cuid())
  tenantId       String
  orderId        String?
  invoiceId      String?
  jurisdictionId String
  netCents       Int
  vatCents       Int
  rateBps        Int
  category       String
  createdAt      DateTime @default(now())

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  order        Order?       @relation(fields: [tenantId, orderId], references: [tenantId, id], onDelete: SetNull)
  invoice      Invoice?     @relation(fields: [tenantId, invoiceId], references: [tenantId, id], onDelete: SetNull)

  @@unique([tenantId, id])
  @@index([tenantId, jurisdictionId])
}

model ReportExport {
  id          String          @id @default(cuid())
  tenantId    String
  type        ReportExportType
  periodStart DateTime
  periodEnd   DateTime
  status      String          @default("PENDING")
  outputUrl   String?
  meta        Json?
  createdAt   DateTime        @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId, type])
}

model AccountingPeriod {
  id            String                  @id @default(cuid())
  tenantId      String
  legalEntityId String
  startDate     DateTime
  endDate       DateTime
  status        AccountingPeriodStatus  @default(OPEN)
  closedAt      DateTime?
  closedByUserId String?
  createdAt     DateTime                @default(now())

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legalEntity LegalEntity @relation(fields: [tenantId, legalEntityId], references: [tenantId, id], onDelete: Cascade)
  journalEntries JournalEntry[]

  @@unique([tenantId, id])
  @@unique([tenantId, legalEntityId, startDate, endDate])
  @@index([tenantId, legalEntityId, status])
}

model Account {
  id            String      @id @default(cuid())
  tenantId      String
  legalEntityId String
  code          String
  name          String
  type          AccountType
  parentId      String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legalEntity LegalEntity  @relation(fields: [tenantId, legalEntityId], references: [tenantId, id], onDelete: Cascade)
  parent      Account?     @relation("AccountToAccount", fields: [parentId], references: [id], onDelete: SetNull)
  children    Account[]    @relation("AccountToAccount")
  journalLines JournalLine[]

  @@unique([tenantId, legalEntityId, code])
  @@unique([tenantId, id])
  @@index([tenantId, legalEntityId, type])
}

model JournalEntry {
  id              String         @id @default(cuid())
  tenantId        String
  legalEntityId   String
  periodId        String?
  status          JournalStatus  @default(DRAFT)
  source          JournalSource?
  bookingDate     DateTime
  currency        String         @default("USD")
  totalDebitCents Int            @default(0)
  totalCreditCents Int           @default(0)
  memo            String?
  correlationId   String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legalEntity LegalEntity     @relation(fields: [tenantId, legalEntityId], references: [tenantId, id], onDelete: Cascade)
  period      AccountingPeriod? @relation(fields: [tenantId, periodId], references: [tenantId, id], onDelete: SetNull)
  lines       JournalLine[]

  @@unique([tenantId, id])
  @@index([tenantId, legalEntityId, bookingDate])
  @@index([tenantId, periodId])
  @@index([tenantId, correlationId])
}

model JournalLine {
  id        String   @id @default(cuid())
  tenantId  String
  entryId   String
  accountId String
  debitCents  Int    @default(0)
  creditCents Int    @default(0)
  memo      String?
  meta      Json?
  createdAt DateTime @default(now())

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  entry   JournalEntry @relation(fields: [tenantId, entryId], references: [tenantId, id], onDelete: Cascade)
  account Account      @relation(fields: [tenantId, accountId], references: [tenantId, id], onDelete: Restrict)

  @@unique([tenantId, id])
  @@index([tenantId, entryId])
  @@index([tenantId, accountId])
}

model PostingLock {
  id             String   @id @default(cuid())
  tenantId       String
  legalEntityId  String
  lockedFromDate DateTime
  reason         String?
  createdAt      DateTime @default(now())

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legalEntity LegalEntity @relation(fields: [tenantId, legalEntityId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId, legalEntityId, lockedFromDate])
}

model AccountantAccess {
  id            String   @id @default(cuid())
  tenantId      String
  userId        String
  legalEntityId String?
  permissions   Json?
  createdAt     DateTime @default(now())

  tenant      Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legalEntity LegalEntity? @relation(fields: [tenantId, legalEntityId], references: [tenantId, id], onDelete: SetNull)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@unique([tenantId, userId, legalEntityId])
  @@index([tenantId, userId])
}

model InventoryItem {
  id        String   @id @default(cuid())
  tenantId  String
  productId String
  location  String?
  quantity  Int      @default(0)
  reserved  Int      @default(0)
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [tenantId, productId], references: [tenantId, id], onDelete: Cascade)

  @@index([tenantId, productId])
}

model Order {
  id              String         @id @default(cuid())
  tenantId        String
  userId          String?
  customerId      String?
  orderNumber     Int
  status          OrderStatus    @default(PENDING)
  currency        String         @default("USD")
  totalCents      Int
  billingAddress  Json?
  shippingAddress Json?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  lines           OrderLine[]
  channelOrders   ChannelOrder[]
  shipments       Shipment[]
  returns         Return[]
  customer        Customer?      @relation(fields: [tenantId, customerId], references: [tenantId, id], onDelete: SetNull)

  tenant  Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user    User?     @relation("UserOrders", fields: [userId], references: [id])
  Invoice Invoice[]
  vatTransactions VatTransaction[]

  @@unique([tenantId, orderNumber])
  @@unique([tenantId, id])
  @@index([tenantId, status])
}

model OrderLine {
  id         String  @id @default(cuid())
  tenantId   String
  orderId    String
  productId  String
  variantId  String?
  quantity   Int
  unitCents  Int
  totalCents Int

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order   Order           @relation(fields: [tenantId, orderId], references: [tenantId, id], onDelete: Cascade)
  product Product         @relation(fields: [tenantId, productId], references: [tenantId, id], onDelete: Restrict)
  variant ProductVariant? @relation(fields: [tenantId, variantId], references: [tenantId, id], onDelete: Restrict)

  stockReservations StockReservation[]
  shipmentLines     ShipmentLine[]
  returnLines       ReturnLine[]
  InvoiceLine       InvoiceLine[]

  @@unique([tenantId, id])
  @@index([tenantId, orderId])
}

model Shipment {
  id          String         @id @default(cuid())
  tenantId    String
  orderId     String
  warehouseId String
  status      ShipmentStatus @default(CREATED)
  carrier     String?
  trackingNo  String?
  shippedAt   DateTime?
  deliveredAt DateTime?
  meta        Json?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tenant    Tenant         @relation("TenantShipments", fields: [tenantId], references: [id], onDelete: Cascade)
  order     Order          @relation(fields: [tenantId, orderId], references: [tenantId, id], onDelete: Cascade)
  warehouse Warehouse      @relation(fields: [tenantId, warehouseId], references: [tenantId, id], onDelete: Restrict)
  lines     ShipmentLine[]

  @@unique([tenantId, id])
  @@index([tenantId, orderId])
}

model ShipmentLine {
  id          String   @id @default(cuid())
  tenantId    String
  shipmentId  String
  orderLineId String
  variantId   String
  qty         Int
  createdAt   DateTime @default(now())

  tenant    Tenant         @relation("TenantShipmentLines", fields: [tenantId], references: [id], onDelete: Cascade)
  shipment  Shipment       @relation(fields: [tenantId, shipmentId], references: [tenantId, id], onDelete: Cascade)
  orderLine OrderLine      @relation(fields: [tenantId, orderLineId], references: [tenantId, id], onDelete: Restrict)
  variant   ProductVariant @relation(fields: [tenantId, variantId], references: [tenantId, id], onDelete: Restrict)

  @@unique([tenantId, id])
  @@index([tenantId, shipmentId])
}

model Return {
  id         String       @id @default(cuid())
  tenantId   String
  orderId    String
  status     ReturnStatus @default(REQUESTED)
  reason     String?
  receivedAt DateTime?
  meta       Json?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  tenant Tenant       @relation("TenantReturns", fields: [tenantId], references: [id], onDelete: Cascade)
  order  Order        @relation(fields: [tenantId, orderId], references: [tenantId, id], onDelete: Cascade)
  lines  ReturnLine[]

  @@unique([tenantId, id])
  @@index([tenantId, orderId])
}

model ReturnLine {
  id          String   @id @default(cuid())
  tenantId    String
  returnId    String
  orderLineId String
  variantId   String
  qty         Int
  condition   String?
  createdAt   DateTime @default(now())

  tenant    Tenant         @relation("TenantReturnLines", fields: [tenantId], references: [id], onDelete: Cascade)
  return    Return         @relation(fields: [tenantId, returnId], references: [tenantId, id], onDelete: Cascade)
  orderLine OrderLine      @relation(fields: [tenantId, orderLineId], references: [tenantId, id], onDelete: Restrict)
  variant   ProductVariant @relation(fields: [tenantId, variantId], references: [tenantId, id], onDelete: Restrict)

  @@unique([tenantId, id])
  @@index([tenantId, returnId])
}

model Customer {
  id              String   @id @default(cuid())
  tenantId        String
  email           String?
  name            String?
  phone           String?
  companyName     String?
  vatNumber       String?
  billingAddress  Json?
  shippingAddress Json?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders   Order[]
  invoices Invoice[]
  quotes   Quote[]

  @@unique([tenantId, id])
  @@unique([tenantId, email])
  @@index([tenantId, companyName])
}

model Invoice {
  id            String        @id @default(cuid())
  tenantId      String
  invoiceNumber Int
  orderId       String
  customerId    String?
  legalEntityId String
  taxProfileId  String?
  status        InvoiceStatus @default(DRAFT)
  currency      String
  subtotalCents Int
  taxCents      Int
  totalCents    Int
  issuedAt      DateTime?
  dueAt         DateTime?
  paidAt        DateTime?
  pdfUrl        String?
  meta          Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  order       Order         @relation(fields: [tenantId, orderId], references: [tenantId, id], onDelete: Cascade)
  customer    Customer?     @relation(fields: [tenantId, customerId], references: [tenantId, id], onDelete: SetNull)
  legalEntity LegalEntity   @relation(fields: [tenantId, legalEntityId], references: [tenantId, id], onDelete: Cascade)
  taxProfile  TaxProfile?   @relation(fields: [tenantId, taxProfileId], references: [tenantId, id], onDelete: SetNull)
  lines       InvoiceLine[]
  vatTransactions VatTransaction[]

  @@unique([tenantId, invoiceNumber])
  @@unique([tenantId, id])
  @@index([tenantId, status])
  @@index([tenantId, orderId])
  @@index([tenantId, customerId])
}

model InvoiceLine {
  id          String  @id @default(cuid())
  tenantId    String
  invoiceId   String
  orderLineId String?
  variantId   String?
  description String
  qty         Int
  unitCents   Int
  totalCents  Int
  taxRateBps  Int?
  meta        Json?

  tenant    Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice   Invoice         @relation(fields: [tenantId, invoiceId], references: [tenantId, id], onDelete: Cascade)
  orderLine OrderLine?      @relation(fields: [tenantId, orderLineId], references: [tenantId, id], onDelete: SetNull)
  variant   ProductVariant? @relation(fields: [tenantId, variantId], references: [tenantId, id], onDelete: SetNull)

  @@unique([tenantId, id])
  @@index([tenantId, invoiceId])
}

model Mailbox {
  id             String          @id @default(cuid())
  tenantId       String
  name           String
  provider       MailboxProvider @default(GENERIC_WEBHOOK)
  inboundAddress String
  outboundFrom   String?
  config         Json?
  lastSyncAt     DateTime?
  lastError      String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  tenant  Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  threads EmailThread[]

  @@unique([tenantId, inboundAddress])
  @@unique([tenantId, id])
  @@index([tenantId])
}

model EmailThread {
  id               String            @id @default(cuid())
  tenantId         String
  mailboxId        String
  status           EmailThreadStatus @default(OPEN)
  subject          String?
  participants     Json?
  externalThreadId String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  mailbox  Mailbox   @relation(fields: [tenantId, mailboxId], references: [tenantId, id], onDelete: Cascade)
  ticket   Ticket?   @relation("TicketEmailThread")
  messages EmailMessage[]

  @@unique([tenantId, id])
  @@index([tenantId, mailboxId])
}

model EmailMessage {
  id        String         @id @default(cuid())
  tenantId  String
  threadId  String
  direction EmailDirection
  messageId String?
  inReplyTo String?
  from      Json
  to        Json
  cc        Json?
  bcc       Json?
  subject   String?
  textBody  String?
  htmlBody  String?
  headers   Json?
  raw       Json?
  sentAt    DateTime?
  createdAt DateTime       @default(now())

  tenant Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  thread EmailThread @relation(fields: [tenantId, threadId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, id])
  @@index([tenantId, threadId])
  @@index([tenantId, messageId])
}

model Plugin {
  id              String               @id @default(cuid())
  key             String               @unique
  name            String
  description     String?
  latestVersion   String?
  channel         String?
  homepage        String?
  configSchema    Json?
  isChannelPlugin Boolean              @default(false)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  installations   PluginInstallation[]
}

model PluginInstallation {
  id          String   @id @default(cuid())
  tenantId    String
  pluginId    String
  version     String
  enabled     Boolean  @default(true)
  config      Json?
  installedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plugin Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade)

  @@unique([tenantId, pluginId])
}

model Jurisdiction {
  id            String        @id @default(cuid())
  code          String        @unique
  countryCode   String
  currency      String
  timezone      String
  legalEntities LegalEntity[]
  taxProfiles   TaxProfile[]
  vatRegistrations VatRegistration[]
  vatTransactions  VatTransaction[]
}

model Organization {
  id        String   @id @default(cuid())
  tenantId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legalEntities LegalEntity[]

  @@unique([tenantId, name])
  @@unique([tenantId, id])
}

model LegalEntity {
  id             String   @id @default(cuid())
  tenantId       String
  organizationId String
  jurisdictionId String
  name           String
  taxId          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [tenantId, organizationId], references: [tenantId, id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Restrict)
  taxProfiles  TaxProfile[]
  Invoice      Invoice[]
  journalEntries JournalEntry[]
  accountingPeriods AccountingPeriod[]
  postingLocks      PostingLock[]
  accountantAccesses AccountantAccess[]

  @@unique([tenantId, name])
  @@unique([tenantId, id])
  @@index([tenantId, jurisdictionId])
}

model TaxProfile {
  id             String   @id @default(cuid())
  tenantId       String
  legalEntityId  String
  jurisdictionId String
  code           String
  ossEnabled     Boolean  @default(false)
  settings       Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  legalEntity  LegalEntity  @relation(fields: [tenantId, legalEntityId], references: [tenantId, id], onDelete: Cascade)
  jurisdiction Jurisdiction @relation(fields: [jurisdictionId], references: [id], onDelete: Restrict)
  Invoice      Invoice[]

  @@unique([tenantId, code])
  @@unique([tenantId, id])
  @@index([tenantId, legalEntityId])
}

model Warehouse {
  id        String   @id @default(cuid())
  tenantId  String
  code      String
  name      String
  address   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stockLedgers      StockLedger[]
  stockSnapshots    StockSnapshot[]
  stockReservations StockReservation[]
  warehouseMappings WarehouseMapping[]
  shipments         Shipment[]

  @@unique([tenantId, code])
  @@unique([tenantId, id])
}

model StockLedger {
  id            String          @id @default(cuid())
  tenantId      String
  warehouseId   String
  variantId     String
  qtyDelta      Int
  kind          StockLedgerKind
  reason        String?
  refType       String?
  refId         String?
  correlationId String?
  createdAt     DateTime        @default(now())

  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouse Warehouse      @relation(fields: [tenantId, warehouseId], references: [tenantId, id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [tenantId, variantId], references: [tenantId, id], onDelete: Cascade)

  @@index([tenantId, warehouseId, variantId])
}

model StockSnapshot {
  id          String   @id @default(cuid())
  tenantId    String
  warehouseId String
  variantId   String
  onHand      Int
  reserved    Int
  available   Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  warehouse Warehouse      @relation(fields: [tenantId, warehouseId], references: [tenantId, id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [tenantId, variantId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, warehouseId, variantId])
}

model StockReservation {
  id          String            @id @default(cuid())
  tenantId    String
  orderLineId String
  warehouseId String
  variantId   String
  qty         Int
  status      ReservationStatus @default(ACTIVE)
  dedupeKey   String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  tenant    Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderLine OrderLine      @relation(fields: [tenantId, orderLineId], references: [tenantId, id], onDelete: Cascade)
  warehouse Warehouse      @relation(fields: [tenantId, warehouseId], references: [tenantId, id], onDelete: Cascade)
  variant   ProductVariant @relation(fields: [tenantId, variantId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, dedupeKey])
  @@unique([tenantId, id])
  @@index([tenantId, orderLineId])
  @@index([tenantId, warehouseId, variantId])
}

model Connector {
  id          String        @id @default(cuid())
  key         String        @unique
  name        String
  type        ConnectorType
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  versions ConnectorVersion[]
}

model ConnectorVersion {
  id          String   @id @default(cuid())
  connectorId String
  version     String
  schema      Json?
  createdAt   DateTime @default(now())

  connector              Connector               @relation(fields: [connectorId], references: [id], onDelete: Cascade)
  integrationConnections IntegrationConnection[]

  @@unique([connectorId, version])
}

model Job {
  id            String    @id @default(cuid())
  tenantId      String
  type          String
  dedupeKey     String?
  correlationId String?
  nextRunAt     DateTime?
  priority      Int       @default(0)
  status        JobStatus @default(PENDING)
  payload       Json
  attempts      Int       @default(0)
  maxAttempts   Int       @default(5)
  scheduledAt   DateTime?
  startedAt     DateTime?
  finishedAt    DateTime?
  lastError     String?
  lockedAt      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  tenant Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  runs   JobRun[]

  @@unique([tenantId, dedupeKey])
  @@unique([tenantId, id])
  @@index([status])
  @@index([tenantId])
  @@index([scheduledAt])
}

model Ticket {
  id                String       @id @default(cuid())
  tenantId          String
  authorId          String
  assigneeId        String?
  emailThreadId     String?
  title             String
  description       String
  status            TicketStatus @default(OPEN)
  priority          Int          @default(3)
  slaDueAt          DateTime?
  lastSlaNotifiedAt DateTime?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  author   User   @relation("TicketAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  assignee User?  @relation("TicketAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  emailThread EmailThread? @relation("TicketEmailThread", fields: [tenantId, emailThreadId], references: [tenantId, id], onDelete: SetNull)

  @@index([tenantId, status])
  @@index([assigneeId])
  @@index([slaDueAt])
  @@index([tenantId, emailThreadId])
  @@unique([tenantId, id])
  @@unique([tenantId, emailThreadId])
}

model JobRun {
  id          String    @id @default(cuid())
  tenantId    String
  jobId       String?
  jobName     String
  status      JobStatus @default(PENDING)
  startedAt   DateTime  @default(now())
  finishedAt  DateTime?
  attempts    Int       @default(0)
  maxAttempts Int       @default(5)
  error       String?
  meta        Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  job    Job?   @relation(fields: [tenantId, jobId], references: [tenantId, id], onDelete: SetNull)

  @@index([status])
  @@index([tenantId, jobName])
  @@index([tenantId, jobId])
}

model AuditEvent {
  id           String   @id @default(cuid())
  tenantId     String
  actorUserId  String?
  action       String
  resourceType String
  resourceId   String
  metadata     Json?
  createdAt    DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  actor  User?  @relation(fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([tenantId, resourceType, resourceId])
}

model IntegrationConnection {
  id                 String    @id @default(cuid())
  tenantId           String
  connectorVersionId String
  name               String?
  region             String?
  status             String    @default("INACTIVE")
  config             Json?
  lastSyncAt         DateTime?
  lastError          String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connectorVersion  ConnectorVersion   @relation(fields: [connectorVersionId], references: [id], onDelete: Cascade)
  warehouseMappings WarehouseMapping[]
  channelProducts   ChannelProduct[]
  channelVariants   ChannelVariant[]
  channelOrders     ChannelOrder[]

  @@unique([tenantId, id])
  @@index([tenantId, connectorVersionId])
  @@index([tenantId, status])
}

model WarehouseMapping {
  id                 String   @id @default(cuid())
  tenantId           String
  connectionId       String
  externalLocationId String
  warehouseId        String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  tenant     Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connection IntegrationConnection @relation(fields: [tenantId, connectionId], references: [tenantId, id], onDelete: Cascade)
  warehouse  Warehouse             @relation(fields: [tenantId, warehouseId], references: [tenantId, id], onDelete: Cascade)

  @@unique([tenantId, connectionId, externalLocationId])
  @@index([tenantId, warehouseId])
}

model ChannelProduct {
  id           String   @id @default(cuid())
  tenantId     String
  connectionId String
  productId    String
  externalId   String
  raw          Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant     Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connection IntegrationConnection @relation(fields: [tenantId, connectionId], references: [tenantId, id], onDelete: Cascade)
  product    Product               @relation(fields: [tenantId, productId], references: [tenantId, id], onDelete: Restrict)

  @@unique([tenantId, connectionId, externalId])
  @@unique([tenantId, connectionId, productId])
}

model ChannelVariant {
  id           String   @id @default(cuid())
  tenantId     String
  connectionId String
  variantId    String
  externalId   String
  asin         String?
  externalSku  String?
  raw          Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant     Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connection IntegrationConnection @relation(fields: [tenantId, connectionId], references: [tenantId, id], onDelete: Cascade)
  variant    ProductVariant        @relation(fields: [tenantId, variantId], references: [tenantId, id], onDelete: Restrict)

  @@unique([tenantId, connectionId, externalId])
  @@unique([tenantId, connectionId, variantId])
}

model ChannelOrder {
  id              String   @id @default(cuid())
  tenantId        String
  connectionId    String
  orderId         String
  externalOrderId String
  raw             Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant     Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  connection IntegrationConnection @relation(fields: [tenantId, connectionId], references: [tenantId, id], onDelete: Cascade)
  order      Order                 @relation(fields: [tenantId, orderId], references: [tenantId, id], onDelete: Restrict)

  @@unique([tenantId, connectionId, externalOrderId])
  @@unique([tenantId, connectionId, orderId])
}
