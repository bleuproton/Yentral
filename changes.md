# Changes Log

- 2025-12-24: Initial scaffolding, README updates, architecture docs, product/integration/job/support API routes, repositories/services, job engine, and seed data with tenant/org/jurisdictions/entities/tax profiles/warehouses/connectors.
- 2025-12-24: Added state check tooling (`db:status`, `db:validate`, `db:generate`, `state:check`) and documentation.
- 2025-12-25: Phase 1 tenant safety: added `tenantId` to User/Account/Session/OrderLine/Job/JobRun with tenant-scoped uniques; Product now requires `sku` with tenant-scoped unique; added Job dedupe/backoff fields; added AuditEvent model; created migration `20251225120000_tenant_safety_phase1` with backfill steps; updated seed/auth for tenant-scoped user lookup.
- 2025-12-25: Added IntegrationConnection model (tenant-scoped), guard/TenantService/IntegrationConnectionService skeletons, tenant-safety SQL check script, and generated full diff migration script `prisma/migrations/20251225124500_tenant_safety_phase1b.sql` (from-empty) capturing current schema.
- 2025-12-25: Phase 2 (variants + enterprise inventory) schema additions: ProductVariant, StockLedger, StockSnapshot, InventoryReservation with enums; OrderLine now has variantId; migration SQL `prisma/migrations/20251225133000_phase2_variants_inventory.sql`; added VariantService and enhanced InventoryService skeletons.
- 2025-12-25: Phase 3 channel/warehouse mappings: added schema models + migration `20251225153000_phase3_channel_mappings`, aligned stock ledger/reservation tables, kept NextAuth global, added channel mapping repositories/services and smoke script (`scripts/smoke_phase3.ts`), README smoke instructions.
- 2025-12-25: Phase 3 patch: added raw payload fields for channel product/variant, aligned updatedAt columns for Prisma @updatedAt, migration `20251225161500_phase3_channel_mappings_patch`, restored Prisma package metadata, added smoke script `scripts/smoke-phase3.ts`.
- 2025-12-25: Added automated DB verification script (`scripts/db/verify.ts`), package scripts `db:verify`, `db:deploy`, `db:check`; tsx already present for running checks.
- 2025-12-25: Added migration consistency check script `scripts/check-migrations.js` and updated `db:check` to run it.
- 2025-12-25: Added Phase2 patch migrations as folders (`20251225170000_phase2_variants_inventory_patch`, `20251225170100_phase2_variants_stock_patch`), moved legacy SQL to `prisma/migrations/_legacy`, fixed stock patch SQL, added DB migration check `scripts/db/check-migrations.mjs` and package script `db:check-migrations`.
- 2025-12-25: Tenant-hardening cleanup: updated schema for composite tenant FKs, removed legacy InventoryReservation, added migration `20251225180000_phase3_cleanup_tenant_hardening`, added TypeScript migration checker `scripts/check-migrations.ts`, package scripts `db:check`, `db:migrate`, `db:studio`.
- 2025-12-25: Enhanced migration checker (`scripts/check-migrations.ts`) to validate drift, expected tables/uniques/tenantId presence with SHADOW_DATABASE_URL requirement; package script `db:check` now uses ts-node ESM; README hook suggestion.
- 2025-12-25: SQL migration fixes: reordered Phase2 folders before Phase3 (`20251225152000_phase2_variants_inventory`, `20251225152100_phase2_variants_stock`), made Phase1 tenant safety idempotent (IF NOT EXISTS on columns/indexes, slug check guarded, constraint drops), made Phase3 channel mappings index renames conditional, added plain Node verifier `scripts/db/verify-migrations.js`, and applied migrations successfully with `prisma migrate deploy`.
- 2025-12-25: Phase 4 fulfillment: added shipment/return enums & models with tenant-safe uniques, generated migration `20251225180000_phase4_fulfillment_shipments_returns`, created fulfillment service, API routes under `/api/v1/shipments` and `/api/v1/returns`, updated inventory repositories for tenant safety and tenant check scripts, and added smoke test `scripts/smoke/phase4_smoke.mjs` plus npm script `smoke:phase4`.
- 2025-12-25: Phase 4 tenant-safety fixes: strengthened Shipment/Return uniques, made StockReservation relations tenant-scoped with composite FKs (updated migration SQL and applied to DB), and revalidated Prisma schema.
- 2025-12-25: Phase 2/3 services finalized: InventoryService now accepts explicit ledger kind and tenant-safe ops; mapping, channel catalog, and channel order services aligned; added tenant-safe smoke test `src/scripts/smoke-phase2-3.ts` and updated `smoke:phase2-3` script.
- 2025-12-25: README enhanced with product overview and ordered roadmap (tenant enforcement, IMAP/SMTP/SLA, billing webhooks, plugin UI first, inventory deprecation, fulfillment providers, and UX/UI sequencing).
- 2025-12-25: Phase 4 validation fixes: explicit relation names for Tenant ↔ ShipmentLine/ReturnLine, removed redundant Return unique, added migration `20251225190000_phase4_fulfillment_relations` (unique keys on tenantId/id for lines/stock reservations); prisma format/validate clean.
- 2025-12-25: Added server-side inventory layer (repositories + InventoryService) with tenant-filtered transactions and smoke script `scripts/smoke-inventory.ts` for adjust/reserve/release/consume flows.
- 2025-12-25: Added Phase 3 integration mapping services (MappingService, ChannelCatalogService, ChannelOrderService) and smoke `scripts/smoke-mappings.ts` for warehouse/product/variant/order mappings.
- 2025-12-25: Added Phase 4 FulfillmentService (shipments/returns) with tenant-safe transactions and smoke script `scripts/smoke-fulfillment.ts`; includes reservation consumption on ship and restock on return.
- 2025-12-25: Added DB verification script `scripts/db-verify.mjs` (migration status + tenant safety checks) and wired npm script `db:verify`.
- 2025-12-25: Phase 2/3 alignment: inventory/mapping/channel services now use server Prisma singleton with tenant filters; updated smoke `scripts/smoke-phase2-3.ts` to match new service signatures.
- 2025-12-25: Fulfillment/returns reimplemented with tenant-safe services (`src/server/services/fulfillment/*`) and shared inventory mutations; new smoke `scripts/smoke-phase4.ts` using tsx loader.
- 2025-12-25: Phase 4 API/services: added tenant-scoped FulfillmentService/ReturnsService with audit logging, validation schemas, tenant guard, and App Router endpoints under `/api/tenant/[tenantId]/shipments|returns`; updated smoke-phase4 to cover ship/deliver/return/refund.
- 2025-12-26: Repaired Prisma installation (clean reinstall via pnpm), fixed schema relations (Customer↔Invoice, Ticket↔EmailThread), regenerated Prisma client, and applied pending migrations (`phase5_invoices`, `phase3_tenant_fk_hardening_v2`). Prisma validate/status now succeed (using HOME override for Prisma cache).
- 2025-12-26: Added automated Phase 6 verification tooling (`scripts/phase6_verify.ts` + npm script `phase6:verify`) checking schema validity, migration folder structure, tenant safety heuristics, and core Prisma commands; added next-step prompt generator (`scripts/phase6_next_prompt.md`).
- 2025-12-26: Phase 6 verifier now loads .env (DATABASE_URL/SHADOW_DATABASE_URL); `npm run phase6:verify` runs validate/status/generate/db pull and reports 0 critical, 8 tenant-safety warnings to address next.
- 2025-12-26: Hardened tenant FK for JobRun→Job (new migration `20251226220000_phase3_cleanup_tenant_hardening`), added JobRun tenant/job index, improved Phase 6 verifier (env load order, migration folder filtering, composite relation heuristics, DB migration consistency check via _prisma_migrations). Current verifier result: 0 critical, 1 warning (rolled-back historical migrations present in DB).
- 2025-12-27: Added non-interactive DB health tooling (`scripts/db_health.ts`, npm `db:health`) and migration generator from diff (`scripts/make_migration_from_diff.ts`, npm `migrate:make`), updated package scripts for deploy/generate; generated/appied guarded migration `20251227001232_phase4_6_align_schema` (mailbox/email tables, tenant-safe ticket/email links). Current status: schema up-to-date; warnings remain for historical rolled-back migrations (_prisma_migrations).
- 2025-12-27: Performed full dev DB reset (`prisma migrate reset --force`), regenerated client, fixed seed for invoice lines (removed tenantId in nested create, made order/orderLine idempotent via upsert), reran seed successfully, verified with `phase6:verify` (0 warnings) and `db:health` (clean).
- 2025-12-27: Phase 7A tenant isolation layer added: console logger, tenant context/ALS, request/build context helpers, tenant guard middleware with automatic tenant injection, RBAC helper, auth resolver fallback, new smoke `smoke:phase7a`, and applied guard to Prisma singleton without schema changes (phase6 verify + db health + smoke pass).
- 2025-12-27: Phase 7B repositories/services for products, variants, integrations/mappings, jobs, and tickets with zod validators and tenant-scoped withContext usage; added smoke `smoke:phase7b` covering product+variant, connector/connection/mapping, job enqueue, and ticket creation (all tenant-safe).
- 2025-12-27: Phase 7C API routes (products, integrations, mappings, jobs, tickets) using tenant buildContext + zod validation + RBAC; added graphile-worker skeleton with sync_connection handler and enqueue script; new helper utilities for API responses; smoke:phase7b still passes.
