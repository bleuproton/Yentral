# Changes Log

- 2025-12-24: Initial scaffolding, README updates, architecture docs, product/integration/job/support API routes, repositories/services, job engine, and seed data with tenant/org/jurisdictions/entities/tax profiles/warehouses/connectors.
- 2025-12-24: Added state check tooling (`db:status`, `db:validate`, `db:generate`, `state:check`) and documentation.
- 2025-12-25: Phase 1 tenant safety: added `tenantId` to User/Account/Session/OrderLine/Job/JobRun with tenant-scoped uniques; Product now requires `sku` with tenant-scoped unique; added Job dedupe/backoff fields; added AuditEvent model; created migration `20251225120000_tenant_safety_phase1` with backfill steps; updated seed/auth for tenant-scoped user lookup.
- 2025-12-25: Added IntegrationConnection model (tenant-scoped), guard/TenantService/IntegrationConnectionService skeletons, tenant-safety SQL check script, and generated full diff migration script `prisma/migrations/20251225124500_tenant_safety_phase1b.sql` (from-empty) capturing current schema.
- 2025-12-25: Phase 2 (variants + enterprise inventory) schema additions: ProductVariant, StockLedger, StockSnapshot, InventoryReservation with enums; OrderLine now has variantId; migration SQL `prisma/migrations/20251225133000_phase2_variants_inventory.sql`; added VariantService and enhanced InventoryService skeletons.
- 2025-12-25: Phase 3 channel/warehouse mappings: added schema models + migration `20251225153000_phase3_channel_mappings`, aligned stock ledger/reservation tables, kept NextAuth global, added channel mapping repositories/services and smoke script (`scripts/smoke_phase3.ts`), README smoke instructions.
- 2025-12-25: Phase 3 patch: added raw payload fields for channel product/variant, aligned updatedAt columns for Prisma @updatedAt, migration `20251225161500_phase3_channel_mappings_patch`, restored Prisma package metadata, added smoke script `scripts/smoke-phase3.ts`.
- 2025-12-25: Added automated DB verification script (`scripts/db/verify.ts`), package scripts `db:verify`, `db:deploy`, `db:check`; tsx already present for running checks.
- 2025-12-25: Added migration consistency check script `scripts/check-migrations.js` and updated `db:check` to run it.
- 2025-12-25: Added Phase2 patch migrations as folders (`20251225170000_phase2_variants_inventory_patch`, `20251225170100_phase2_variants_stock_patch`), moved legacy SQL to `prisma/migrations/_legacy`, fixed stock patch SQL, added DB migration check `scripts/db/check-migrations.mjs` and package script `db:check-migrations`.
- 2025-12-25: Tenant-hardening cleanup: updated schema for composite tenant FKs, removed legacy InventoryReservation, added migration `20251225180000_phase3_cleanup_tenant_hardening`, added TypeScript migration checker `scripts/check-migrations.ts`, package scripts `db:check`, `db:migrate`, `db:studio`.
- 2025-12-25: Enhanced migration checker (`scripts/check-migrations.ts`) to validate drift, expected tables/uniques/tenantId presence with SHADOW_DATABASE_URL requirement; package script `db:check` now uses ts-node ESM; README hook suggestion.
- 2025-12-25: SQL migration fixes: reordered Phase2 folders before Phase3 (`20251225152000_phase2_variants_inventory`, `20251225152100_phase2_variants_stock`), made Phase1 tenant safety idempotent (IF NOT EXISTS on columns/indexes, slug check guarded, constraint drops), made Phase3 channel mappings index renames conditional, added plain Node verifier `scripts/db/verify-migrations.js`, and applied migrations successfully with `prisma migrate deploy`.
